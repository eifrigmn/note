# 流水线与事务

## 流水线特性

一般情况下，用户每执行一个Redis命令，Redis的客户端和服务器之间需要执行如下的步骤：

+ 客户端向服务端发送命令请求
+ 服务端接收到命令请求，执行指定的命令调用，产生相应的执行结果
+ 服务器向客户端返回结果
+ 客户端接收到结果，向用户进行展示

Redis服务器内部，每个指令的执行是非常快的，因此，上述流程的时间消耗，主要在Redis客户端与服务器之间的通信交互。

Redis的流水线特性，允许客户端把任意多条Redis命令请求打包在一起交由服务器执行，这样，在单次交互可以完成多个命令的执行，节省了网络开销。

## 事务

虽然Redis的LPUSH和RPUSH命令允许用户一次向列表推入多个元素，但是列表的弹出是单个元素。使用循环或者流水线特性，可以实现多个命令的输入，但是无法保证每条命令都被成功执行。

Redis的事务特性，就是一种能够让Redis服务器将多个命令打包起来一并执行的技术。而被打包的命令的执行状态也是被”打包“的——事务执行成功，则所有命令被执行，事务执行失败，那所有命令都不会被执行。

+ MULTI：开启事务
+ EXEC：执行事务
+ DISCARD：放弃事务

### 事务的安全性

Redis的事务具有原子性(Atomic)、一致性(Consistent)和隔离性(Isolate)的性质。

## 乐观锁与悲观锁

###  乐观锁

总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候，会判断一下在此期间别人有没有去更新这个数据。

乐观锁适用于多读少写的应用类型。

#### Redis的乐观锁机制

通过WATCH命令对一个或多个键实施监视，如果在客户端尝试执行事务之前，这些锁的值发生了变化，那么服务器将拒绝执行客户端发送的事务，反之则正常执行事务。

### 悲观锁

总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次读数据的时候会上锁。

悲观锁适用于多写的场景。