# 概述

Redis(REmote DIctionary Server)是一个开源的内存型数据结构服务器，可用作数据库、高速缓存、消息队列等，是一个高性能的key-value数据库。

## 缓存

在高并发的场景下，大量的读写请求可能会超出数据库服务器的承载能力，导致业务服务出现性能瓶颈甚至系统由于超载而宕机。在应用层和数据库服务层引入缓存，将热点数据存储于缓存而减少对数据库层的io请求，可以有效地提高系统的响应速度，让有限的资源服务于更多的用户。

缓存服务一般可以概括为以下三种类型：

### 本地缓存

即在进程的内存中进行缓存

+ 优点

  应用服务与cache在同一个进程内部，请求响应速度非常快，没有过多的网络开销，适用于单机应用无集群需求的场景。

+ 缺点

  缓存与应用服务耦合度较高，且受限于单机容量，无法扩展

分布式架构中如果采用本地缓存机制，可以使用消息队列在各应用间进行数据一致性检查

### 分布式缓存

即进程外缓存，应用服务与缓存服务进行分离，各应用共享同一个缓存服务，保证了数据一致性。

分布式缓存服务中，可以通过增加缓存节点来进行水平扩展，但是由于服务分离，需要进行远程请求。

### 多级缓存

在整个系统架构的不同系统层级进行数据缓存，以提高访问效率。

~~~mermaid
graph TD
cli(Client) --> app[Application]
app --> lc[Local Cache]
lc --> c[Cache Cluster]
c --> cm(Master //Write Only)
c --> s1(Slave1 //Read Only)
c --> s2(Slave2 //Read Only)
c --> s(...)
~~~

## 对比memcached

redis数据结构类型丰富

支持数据持久化

原生支持集群模式

## 单线程工作模型

Redis服务器是一个事件驱动程序，服务器需要处理**文件事件**和**时间事件**这两类事件：

+ 文件事件

Redis服务端与客户端采用socket通信，服务器与客户端之间的通信会产生相应的文件事件，而服务器通过监听并处理这些事件来完成一系列网络通信操作，文件事件被存放在一个无序链表中。

+ 时间事件

定点事件以及周期性事件

**事件处角度下的服务器运行流程：**

~~~mermaid
graph TD
start(启动服务器) --> if{是否关闭服务器?}
if -->|是| stop(关闭服务器)
if -->|否| file[等待文件事件产生]
file --> p[处理已产生的文件事件]
p --> time[处理已达到的时间事件]
time -->|开始新的事件循环| if
~~~

### Redis事件处理器进行事件处理的时候是多线程还是单线程？

Redis事件处理器对文件事件和时间事件的处理都是同步、有序、原子地执行的，服务器不会中途中断事件处理，也不会对事件进行抢占。如果等待并处理完一次文件事件之后，仍未有任何时间事件到达，那么服务器将再次等待并处理文件事件。

### 为什么说Redis能够快速执行

绝大部分请求是内存操作

采用单线程工作模型，避免了不必要的上下文切换和竞争条件

IO多路复用

## Redis的多线程

Redis 6.0将引入多线程特性，优化的方向主要为：

+ 提高网络IO性能
+ 使用多线程充分利用多核

Redis的多线程主要用来处理网络数据的读写和协议解析，具体表现为：

1. 主线程负责接收建连请求，读事件到来(收到请求)则放到一个全局等待读处理队列
2. 主线程处理完读事件之后，通过 RR(Round Robin) 将这些连接分配给这些 IO 线程，然后主线程忙等待(spinlock 的效果)状态
3. IO 线程将请求数据读取并解析完成(这里只是读数据和解析并不执行)
4. 主线程执行所有命令并清空整个请求等待读处理队列(执行部分串行)

也就是说，IO线程负责处理读取请求数据及解析，转化后的执行命令放到一个队列里面等待主线程执行。

## 参考

<https://redis.io/>

[亿级请求下多级缓存那些事](<https://yq.aliyun.com/articles/328515>)

[多级缓存设计详解](<https://cloud.tencent.com/developer/article/1170601>)

[缓存那些事](<https://cloud.tencent.com/developer/article/1058203>)

[Redis常见面试题](<https://github.com/AobingJava/JavaFamily/blob/master/docs/redis/Redis%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98.md>)

《Redis设计与实现》