# 持久化

Redis的持久化，就是把内存中的数据写入到磁盘中。Redis是内存数据库，如果没有配置持久化，Redis重启后，服务器中的数据库状态也会消失不见。Redis提供了三种方式进行持久化：

## RDB持久化

RDB是一种快照存储持久化方式，其原理是将Redis在内存中的数据库记录定时dump到磁盘上。RDB持久化既可以手动执行，也可以根据服务器配置选项定期执行。

+ 手动触发

使用SAVE或者BGSAVE命令，二者的区别是SAVE会阻塞Redis服务器进程，而BGSAVE会fort出一个子进程，然后由子进程负责创建RDB文件，父进程继续处理命令请求。

+ 通过配置触发

通过修改配置的save选项来让服务器每隔一段时间自动执行一次BGSAVE命令。

#### 优点

+ RDB保存了Redis在某个时间点上的数据集，非常适合进行备份操作和灾难恢复。

+ 使用BGSAVE命令进行持久化操作时，会fork出来一个子进程进行所有的保存工作，父进程可以继续正常处理请求。

+ RDB在恢复大数据集时比AOF速度快。

#### 缺点

+ RDB是定时保存数据，在定时保存之前服务由于各种原因停机后，数据会丢失
+ 每次保存RDB都要fork出一个子进程进行操作，如果数据集比较大时，fork操作可能会非常耗时，甚至会影响主进程。

## AOF持久化

AOF(Append Only File)持久化是通过保存Redis服务器锁执行的写命令来记录数据库的状态的。AOF功能的实现可以分为：命令追加、文件写入、文件同步三个步骤。

+ 命令追加

当AOF持久化功能开启时，服务器在每执行完一个写命令后，会将该条命令追加到aof_buf缓冲区末尾。

+ 文件写入与同步

Redis的服务器在每次结束一个事件循环之前，会根据`appendsync`的配置来决定是否将aof_buf缓冲区中的内容写入和保存到AOF文件中，不同的`appendsync`值产生的不同的持久化行为如下：

| appendsync选项的值 | flushAppendOnlyFile函数的行为                                |
| :----------------- | :----------------------------------------------------------- |
| always             | 将aof_buf缓冲区中的所有内容写入并同步到AOF文件               |
| everysec           | 将aof_buf缓冲区中的所有内容写入到AOF文件，如果上次同步AOF文件的时间距现在超过一秒钟，那么再次对AOF文件进行同步，并且这个同步操作是由一个线程专门负责执行的。 |
| no                 | 将aof_buf缓冲区中的所有内容写入到AOF文件，由操作系统来决定何时同步AOF文件。 |

### 优点

比RDB方式更加耐久，根据不同的fsync策略，即便服务器发生故障停机，丢失的数据量也是非常少的

AOF是追加写，写入时不需要seek

AOF文件体积变得过大时，Redis会自动地在后台对AOF重写并保证数据不丢失

### 缺点

相同的数据，AOF文件的体积通常更大

根据所使用的fsync策略，AOF的速度可能慢于RDB

## RDB-AOF混合持久化

Redis 4.0新增的持久化方式，原理是在AOF重写时，直接以RDB的方式把数据库的状态保存起来，再用AOF的方式追加增量日志。

## 扩容

Redis持久化数据和缓存进行扩容时，可以从以下两点考虑

+ Redis作为缓存服务时，使用一致性哈希实现动态扩容
+ Redis的数据存在持久化操作时，应该使用Redis集群